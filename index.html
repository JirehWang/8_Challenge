<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>8-Grid Challenge - Local Zero Latency</title>
    <style>
        :root { --bg: #1a1a1a; --accent: #00fbff; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none !important; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* æ§å°æ¨£å¼ */
        button { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin: 10px 0; width: 100%; }
        .btn-open { background: #0984e3; color: white; }
        .btn-start { background: #ff4757; color: white; font-size: 18px; }
        input[type="file"], select { background: #1a1a1a; color: white; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #444; margin: 5px 0; }

        /* èˆå°ç¶²æ ¼ */
        #stage-ui { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: repeat(4, 200px); grid-template-rows: repeat(2, 200px); gap: 15px; }
        .box { width: 200px; height: 200px; background: #222; border: 3px solid #333; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .box.active img { display: block; }
        #countdown-txt { position: absolute; font-size: 150px; font-weight: bold; color: var(--accent); text-shadow: 0 0 30px var(--accent); }
    </style>
</head>
<body>

    <div id="host-ui" class="card">
        <h1>ğŸ® å…«æ ¼æŒ‘æˆ°æ§å°</h1>
        <button class="btn-open" onclick="openStageWindow()">ğŸ–¥ï¸ é–‹å•ŸéŠç©èˆå° (æ‹–è‡³ç¬¬äºŒè¢å¹•)</button>
        <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
        <div style="text-align: left;">
            <label>ğŸ“ è¨­å®šé¡Œåº«ï¼š</label>
            <select id="bankIdx"><option value="0">é¡Œåº« 1</option><option value="1">é¡Œåº« 2</option></select>
            <input type="file" id="fileInput" multiple accept="image/*" onchange="loadLocalFiles()">
            <p id="status" style="font-size:12px; color:var(--accent);">ç­‰å¾…è¼‰å…¥åœ–ç‰‡...</p>
            
            <label>â±ï¸ æ¯è¼ªç§’æ•¸ï¼š</label>
            <input type="number" id="secInput" value="8">
        </div>
        <button class="btn-start" onclick="sendStartSignal()">ğŸš€ é–‹å§‹ 3 å¾ªç’°æŒ‘æˆ°</button>
    </div>

    <div id="stage-ui" class="hidden">
        <div id="round-info" style="font-size: 24px; color:#888;">ROUND 1 / 3</div>
        <div id="timer-bar" style="font-size: 48px; color: #f1c40f; margin:10px 0;">READY</div>
        <div id="countdown-txt"></div>
        <div class="grid" id="mainGrid">
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
        </div>
    </div>

    <script>
        const bc = new BroadcastChannel('local_8grid');
        let localBanks = [[], []];

        // --- æ§å°é‚è¼¯ ---
        function openStageWindow() {
            // é–‹å•Ÿä¸€å€‹æ–°çš„è‡ªå·±ï¼Œä¸¦åœ¨ç¶²å€åŠ ä¸Šæ¨™è¨˜
            window.open(window.location.href + '?role=stage', '_blank', 'width=1200,height=800');
        }

        async function loadLocalFiles() {
            const idx = document.getElementById('bankIdx').value;
            const files = Array.from(document.getElementById('fileInput').files);
            localBanks[idx] = [];
            for (let f of files) {
                const b64 = await new Promise(res => {
                    const r = new FileReader();
                    r.onload = e => res(e.target.result);
                    r.readAsDataURL(f);
                });
                localBanks[idx].push(b64);
            }
            document.getElementById('status').innerText = `é¡Œåº« ${parseInt(idx)+1} å·²å‚™å¦¥ ${localBanks[idx].length} å¼µåœ–`;
        }

        function sendStartSignal() {
            const idx = document.getElementById('bankIdx').value;
            if (localBanks[idx].length < 4) return alert("è«‹å…ˆè¼‰å…¥è‡³å°‘ 4 å¼µåœ–");
            
            bc.postMessage({
                type: 'START_GAME',
                bank: localBanks[idx],
                sec: document.getElementById('secInput').value
            });
        }

        // --- èˆå°é‚è¼¯ (è‡ªå‹•åˆ¤å®šè§’è‰²) ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('role') === 'stage') {
            document.getElementById('host-ui').classList.add('hidden');
            document.getElementById('stage-ui').classList.remove('hidden');
            document.body.style.padding = "0";
        }

        bc.onmessage = (e) => {
            if (e.data.type === 'START_GAME') {
                runTripleCycle(e.data.bank, e.data.sec);
            }
        };

        async function runTripleCycle(bank, sec) {
            const timerEl = document.getElementById('timer-bar'),
                  roundEl = document.getElementById('round-info'),
                  overlay = document.getElementById('countdown-txt'),
                  boxes = document.querySelectorAll('.box');

            for (let r = 1; r <= 3; r++) {
                roundEl.innerText = `ROUND ${r} / 3`;
                boxes.forEach(b => { b.innerHTML = ""; b.classList.remove('active'); });
                
                // 3-2-1 å€’æ•¸
                for (let c = 3; c > 0; c--) {
                    overlay.innerText = c;
                    await new Promise(res => setTimeout(res, 1000));
                }
                overlay.innerText = "";

                // 8é¸4 éš¨æ©Ÿæ’åˆ—
                const lucky4 = [...bank].sort(() => 0.5 - Math.random()).slice(0, 4);
                const final = [...lucky4, ...lucky4].sort(() => 0.5 - Math.random());
                boxes.forEach((b, i) => {
                    b.innerHTML = `<img src="${final[i]}" style="display:block">`;
                    b.classList.add('active');
                });

                let left = parseInt(sec);
                while (left >= 0) {
                    timerEl.innerText = left + "s";
                    await new Promise(res => setTimeout(res, 1000));
                    left--;
                }
                timerEl.innerText = "NEXT ROUND...";
                boxes.forEach(b => b.classList.remove('active'));
                await new Promise(res => setTimeout(res, 2000));
            }
            timerEl.innerText = "FINISH!";
        }
    </script>
</body>
</html>
