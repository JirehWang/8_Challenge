<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Grid Challenge - Firebase v12</title>
    <style>
        :root { --bg: #121212; --card: #252525; --accent: #00fbff; --text: #e0e0e0; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none !important; }
        .card { background: var(--card); padding: 25px; border-radius: 15px; width: 95%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; margin-top: 10px; }
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a1a; color: white; width: 100%; box-sizing: border-box; margin-top: 10px; font-size: 16px; }
        button { background: #444; cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        .btn-primary { background: var(--accent); color: #000; }
        .status-bar { font-size: 14px; margin-bottom: 10px; color: #2ed573; font-weight: bold; }
        
        /* éŠæˆ²èˆå° */
        #stage-ui { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: repeat(4, 20vw); grid-template-rows: repeat(2, 20vw); gap: 10px; }
        @media (min-width: 1000px) { .grid { grid-template-columns: repeat(4, 180px); grid-template-rows: repeat(2, 180px); } }
        .box { background: #1a1a1a; border: 2px solid #333; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .box.active img { display: block; }
        #countdown-txt { position: absolute; font-size: 150px; font-weight: bold; color: var(--accent); text-shadow: 0 0 30px var(--accent); pointer-events: none; }
    </style>
</head>
<body>

    <div id="login-ui" class="card">
        <h1>ğŸ™ï¸ å…«æ ¼æŒ‘æˆ° (v12)</h1>
        <p>è¼¸å…¥æˆ¿é–“è™Ÿç¢¼é€²å…¥åŒæ­¥ç©ºé–“</p>
        <input type="text" id="roomIdInput" placeholder="æˆ¿é–“è™Ÿç¢¼" style="text-align:center;">
        <button class="btn-primary" onclick="initGameRoom()">é€²å…¥æˆ¿é–“</button>
    </div>

    <div id="lobby-ui" class="card hidden">
        <div class="status-bar">â— Firebase é›²ç«¯åŒæ­¥ä¸­</div>
        <h2 style="margin:0; color:var(--accent);">æˆ¿é–“ï¼š<span id="display-id">---</span></h2>
        
        <div style="text-align: left; margin-top: 15px;">
            <label>ğŸ“ é¡Œåº«ï¼š</label>
            <select id="bankSelector">
                <option value="0">é¡Œåº« 1</option>
                <option value="1">é¡Œåº« 2</option>
            </select>
            <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFileUpload()">
            <p id="bank-status" style="font-size:12px; color:var(--accent);">é¸å– 8 å¼µåœ–è‡ªå‹•åŒæ­¥</p>
            
            <label>â±ï¸ æŒ‘æˆ°ç§’æ•¸ï¼š</label>
            <input type="number" id="secInput" value="8" onchange="syncSettings()">
        </div>

        <button class="btn-primary" style="background:#ff4757; color:white; margin-top:20px;" onclick="triggerStart()">ğŸš€ é–‹å§‹æŒ‘æˆ° (ä¸‰å¾ªç’°)</button>
    </div>

    <div id="stage-ui" class="hidden">
        <div id="round-info" style="font-size: 24px; color:#888;">ROUND 1 / 3</div>
        <div id="timer-bar" style="font-size: 48px; color: #f1c40f; margin:10px 0;">READY</div>
        <div id="countdown-txt"></div>
        <div class="grid">
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, set } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJmAb9duu6xkUZ3BtiaBsesvOGlvqcaZ8",
            authDomain: "challenge-49014.firebaseapp.com",
            projectId: "challenge-49014",
            storageBucket: "challenge-49014.firebasestorage.app",
            messagingSenderId: "466367927284",
            appId: "1:466367927284:web:0294e616f8d17182d8dfa1",
            measurementId: "G-5BVTK9RLRK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentRoomId = "";
        let localBanks = [[], []];

        // å°‡å‡½å¼æ›è¼‰åˆ° window ä»¥ä¾› HTML onclick ä½¿ç”¨
        window.initGameRoom = () => {
            currentRoomId = document.getElementById('roomIdInput').value.trim();
            if (!currentRoomId) return;

            document.getElementById('login-ui').classList.add('hidden');
            document.getElementById('lobby-ui').classList.remove('hidden');
            document.getElementById('display-id').innerText = currentRoomId;

            const roomRef = ref(db, 'rooms/' + currentRoomId);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.banks) localBanks = data.banks;
                    if (data.sec) document.getElementById('secInput').value = data.sec;
                    if (data.gameTrigger && data.gameTrigger.status === 'START') {
                        if (document.getElementById('stage-ui').classList.contains('hidden')) {
                            runGame(data.gameTrigger.bank, data.gameTrigger.sec);
                        }
                    }
                    updateLocalUI();
                }
            });
        };

        window.handleFileUpload = async () => {
            const idx = document.getElementById('bankSelector').value;
            const files = Array.from(document.getElementById('fileInput').files);
            const compressed = [];
            document.getElementById('bank-status').innerText = "è™•ç†ä¸­...";

            for (let f of files) {
                const b64 = await compressImage(f);
                compressed.push(b64);
            }
            localBanks[idx] = compressed;
            syncSettings();
        };

        window.syncSettings = () => {
            if (!currentRoomId) return;
            update(ref(db, 'rooms/' + currentRoomId), {
                banks: localBanks,
                sec: document.getElementById('secInput').value,
                gameTrigger: { status: 'WAITING' }
            });
        };

        window.triggerStart = () => {
            const idx = document.getElementById('bankSelector').value;
            const sec = document.getElementById('secInput').value;
            if (!localBanks[idx] || localBanks[idx].length < 4) return alert("åœ–ç‰‡ä¸è¶³");

            set(ref(db, 'rooms/' + currentRoomId + '/gameTrigger'), {
                status: 'START',
                bank: localBanks[idx],
                sec: sec,
                timestamp: Date.now()
            });
        };

        function compressImage(file) {
            return new Promise((res) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 400; 
                        let w = img.width, h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        }

        function updateLocalUI() {
            const idx = document.getElementById('bankSelector').value;
            const count = localBanks[idx] ? localBanks[idx].length : 0;
            document.getElementById('bank-status').innerText = `é¡Œåº« ${parseInt(idx)+1}ï¼šç¾æœ‰ ${count} å¼µåœ–`;
        }

        async function runGame(bank, sec) {
            document.getElementById('stage-ui').classList.remove('hidden');
            const timerEl = document.getElementById('timer-bar'), roundEl = document.getElementById('round-info'), overlay = document.getElementById('countdown-txt'), boxes = document.querySelectorAll('.box');

            for (let r = 1; r <= 3; r++) {
                roundEl.innerText = `ROUND ${r} / 3`;
                boxes.forEach(b => { b.innerHTML = ""; b.classList.remove('active'); });
                for (let c = 3; c > 0; c--) { overlay.innerText = c; await new Promise(res => setTimeout(res, 1000)); }
                overlay.innerText = "";

                const lucky4 = [...bank].sort(() => 0.5 - Math.random()).slice(0, 4);
                const final = [...lucky4, ...lucky4].sort(() => 0.5 - Math.random());
                boxes.forEach((b, i) => { b.innerHTML = `<img src="${final[i]}" style="display:block">`; b.classList.add('active'); });

                let left = parseInt(sec);
                while (left >= 0) { timerEl.innerText = left + "s"; await new Promise(res => setTimeout(res, 1000)); left--; }
                timerEl.innerText = "READY...";
                boxes.forEach(b => b.classList.remove('active'));
                await new Promise(res => setTimeout(res, 1500));
            }
            document.getElementById('stage-ui').classList.add('hidden');
            set(ref(db, 'rooms/' + currentRoomId + '/gameTrigger'), { status: 'WAITING' });
        }
    </script>
</body>
</html>
