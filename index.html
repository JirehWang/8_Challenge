<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>8-Grid Challenge - Connection Guard</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #00fbff; --danger: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none !important; }

        /* æ§å°å¡ç‰‡ */
        .card { background: var(--card); padding: 30px; border-radius: 20px; width: 95%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #333; text-align: center; }
        
        button { 
            padding: 15px 25px; border-radius: 12px; border: none; cursor: pointer; 
            font-weight: bold; font-size: 16px; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 10px 0; width: 100%; position: relative;
        }
        button:active { transform: scale(0.95); }
        .btn-open { background: #0984e3; color: white; }
        .btn-start { background: var(--danger); color: white; font-size: 20px; }
        .btn-start:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }

        /* é€£ç·šç‡ˆè™Ÿ */
        .status-bar { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; font-size: 14px; background: #000; padding: 10px; border-radius: 50px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4757; margin-right: 10px; transition: 0.3s; }
        .dot.online { background: #2ed573; box-shadow: 0 0 10px #2ed573; }

        input, select { background: #111; color: #fff; padding: 12px; border-radius: 8px; border: 1px solid #444; width: 100%; box-sizing: border-box; margin: 8px 0; }

        /* èˆå°å€åŸŸ */
        #stage-ui { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #countdown-txt { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 300px; font-weight: bold; color: var(--accent); 
            text-shadow: 0 0 60px rgba(0,251,255,1); z-index: 9999; pointer-events: none; 
        }
        .grid { display: grid; grid-template-columns: repeat(4, 200px); grid-template-rows: repeat(2, 200px); gap: 20px; z-index: 1; }
        .box { width: 200px; height: 200px; background: #0a0a0a; border: 3px solid #222; border-radius: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        
        /* ä¿®æ­£ï¼šä½¿ç”¨ contain æ¨¡å¼ï¼Œç¢ºä¿åœ–ç‰‡ä¸è¢«æˆªæ‰ */
        .box img { width: 100%; height: 100%; object-fit: contain; background: #000; display: none; }
        .box.active img { display: block; }
    </style>
</head>
<body>

    <div id="host-ui" class="card">
        <h1>ğŸ™ï¸ å…«æ ¼æŒ‘æˆ°æ§å°</h1>
        
        <div class="status-bar">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">ç­‰å¾…èˆå°è¦–çª—é–‹å•Ÿ...</span>
        </div>

        <button class="btn-open" onclick="openStageWindow()">ğŸ–¥ï¸ 1. é–‹å•Ÿèˆå° (æ‹–è‡³å‰¯è¢å¹•)</button>
        
        <div style="text-align: left; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px;">
            <label>ğŸ“ é¸æ“‡é¡Œåº«ï¼š</label>
            <select id="bankIdx"><option value="0">é¡Œåº« 1</option><option value="1">é¡Œåº« 2</option></select>
            <input type="file" id="fileInput" multiple accept="image/*" onchange="loadFiles()">
            <p id="file-count" style="font-size:12px; color:var(--accent);">å°šæœªè¼‰å…¥åœ–ç‰‡</p>
            
            <label>â±ï¸ ç§’æ•¸è¨­å®šï¼š</label>
            <input type="number" id="secInput" value="8">
        </div>

        <button class="btn-start" id="startBtn" onclick="sendStartSignal()">ğŸš€ 2. é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="stage-ui" class="hidden">
        <div id="round-info" style="font-size: 40px; color:#444; position: absolute; top: 40px; left: 40px; font-weight: bold;">READY</div>
        <div id="timer-bar" style="font-size: 80px; color: #f1c40f; position: absolute; top: 40px; font-family: monospace;"></div>
        <div id="countdown-txt"></div>
        <div class="grid">
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
        </div>
    </div>

    <script>
        const bc = new BroadcastChannel('eight_grid_secure_channel');
        let myBanks = [[], []];
        let lastHeartbeat = 0;
        let isStageConnected = false;

        // --- æ§å°é€£ç·šå®ˆè­·é‚è¼¯ ---
        function checkConnection() {
            const now = Date.now();
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const startBtn = document.getElementById('startBtn');

            // å¦‚æœè¶…é 2 ç§’æ²’å¿ƒè·³ï¼Œåˆ¤å®šç‚ºæ–·ç·š
            if (now - lastHeartbeat > 2000) {
                if (isStageConnected) {
                    dot.classList.remove('online');
                    statusText.innerText = "èˆå°å·²ä¸­æ–·ï¼Œè«‹é‡æ–°é–‹å•Ÿ";
                    isStageConnected = false;
                    // å¼·åˆ¶æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ï¼Œä»¥ä¾¿é‡æ–°é–‹å§‹
                    resetControllerUI();
                }
            }
        }
        setInterval(checkConnection, 1000);

        function resetControllerUI() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.innerText = "ğŸš€ 2. é–‹å§‹æŒ‘æˆ°";
            startBtn.style.background = "var(--danger)";
        }

        bc.onmessage = (e) => {
            if (e.data.type === 'HEARTBEAT') {
                lastHeartbeat = Date.now();
                if (!isStageConnected) {
                    document.getElementById('status-dot').classList.add('online');
                    document.getElementById('status-text').innerText = "èˆå°é€£ç·šæˆåŠŸ";
                    isStageConnected = true;
                }
            } else if (e.data.type === 'STAGE_CLOSED') {
                lastHeartbeat = 0; // ç«‹å³è§¸ç™¼æ–·ç·šé‚è¼¯
                checkConnection();
            }
        };

        function openStageWindow() {
            window.open(window.location.href + '?role=stage', 'StageWindow', 'width=1200,height=800');
        }

        async function loadFiles() {
            const idx = document.getElementById('bankIdx').value;
            const files = Array.from(document.getElementById('fileInput').files);
            myBanks[idx] = [];
            for (let f of files) {
                const b64 = await new Promise(res => {
                    const r = new FileReader();
                    r.onload = e => res(e.target.result);
                    r.readAsDataURL(f);
                });
                myBanks[idx].push(b64);
            }
            document.getElementById('file-count').innerText = `é¡Œåº« ${parseInt(idx)+1} å·²è¼‰å…¥ ${myBanks[idx].length} å¼µ`;
        }

        function sendStartSignal() {
            const idx = document.getElementById('bankIdx').value;
            if (!isStageConnected) return alert("èˆå°è¦–çª—å°šæœªé–‹å•Ÿæˆ–å·²æ–·ç·šï¼");
            if (myBanks[idx].length < 4) return alert("åœ–ç‰‡ä¸è¶³ 4 å¼µï¼");

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.innerText = "æŒ‘æˆ°åŸ·è¡Œä¸­...";
            startBtn.style.background = "#555";

            bc.postMessage({
                type: 'START_SIGNAL',
                bank: myBanks[idx],
                sec: document.getElementById('secInput').value
            });
        }

        // --- èˆå°ç«¯é‚è¼¯ ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('role') === 'stage') {
            document.getElementById('host-ui').classList.add('hidden');
            document.getElementById('stage-ui').classList.remove('hidden');
            document.body.style.overflow = "hidden";

            // æŒçºŒç™¼é€å¿ƒè·³
            setInterval(() => {
                bc.postMessage({ type: 'HEARTBEAT' });
            }, 1000);

            // è¦–çª—é—œé–‰æ™‚ä¸»å‹•é€šçŸ¥
            window.addEventListener('beforeunload', () => {
                bc.postMessage({ type: 'STAGE_CLOSED' });
            });
        }

        let isRunning = false;
        bc.addEventListener('message', (e) => {
            if (e.data.type === 'START_SIGNAL' && !isRunning) {
                runTripleCycle(e.data.bank, e.data.sec);
            }
        });

        async function runTripleCycle(bank, sec) {
            isRunning = true;
            const timerEl = document.getElementById('timer-bar');
            const roundEl = document.getElementById('round-info');
            const overlay = document.getElementById('countdown-txt');
            const boxes = document.querySelectorAll('.box');

            for (let r = 1; r <= 3; r++) {
                roundEl.innerText = `ROUND ${r} / 3`;
                timerEl.innerText = "";
                boxes.forEach(b => { b.innerHTML = ""; b.classList.remove('active'); });

                // 3-2-1 ç½®é ‚å€’æ•¸
                for (let c = 3; c > 0; c--) {
                    overlay.innerText = c;
                    await new Promise(res => setTimeout(res, 1000));
                }
                overlay.innerText = "";

                const luckyFour = [...bank].sort(() => 0.5 - Math.random()).slice(0, 4);
                const finalSet = [...luckyFour, ...luckyFour].sort(() => 0.5 - Math.random());
                
                boxes.forEach((box, i) => {
                    box.innerHTML = `<img src="${finalSet[i]}" style="display:block">`;
                    box.classList.add('active');
                });

                let left = parseInt(sec);
                while (left >= 0) {
                    timerEl.innerText = left + "s";
                    await new Promise(res => setTimeout(res, 1000));
                    left--;
                }

                boxes.forEach(b => b.classList.remove('active'));
                timerEl.innerText = "READY...";
                await new Promise(res => setTimeout(res, 2000));
            }

            timerEl.innerText = "æŒ‘æˆ°çµæŸï¼";
            isRunning = false;
            // é€šçŸ¥æ§å°æ¢å¾©æŒ‰éˆ•
            bc.postMessage({ type: 'STAGE_CLOSED' }); 
        }
    </script>
</body>
</html>
