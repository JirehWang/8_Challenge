<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Grid Challenge - Room Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #121212; --panel: #2d2d2d; --accent: #00d2ff; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--panel); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .hidden { display: none; }
        input, select, button { padding: 10px; border-radius: 5px; border: none; margin: 5px 0; font-size: 16px; }
        button { cursor: pointer; background: #444; color: white; transition: 0.2s; }
        button:hover { background: #555; }
        .btn-start { background: #ff4757; font-weight: bold; width: 100%; margin-top: 15px; }
        .status { font-size: 13px; color: #888; margin-top: 5px; }

        /* éŠæˆ²èˆå°æ¨£å¼ (å¦é–‹è¦–çª—ç”¨) */
        #stage-content { text-align: center; width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; }
        .grid { display: grid; grid-template-columns: repeat(4, 200px); grid-template-rows: repeat(2, 200px); gap: 15px; }
        .box { width: 200px; height: 200px; background: #222; border-radius: 10px; overflow: hidden; position: relative; border: 3px solid #333; }
        .box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .box.active img { display: block; }
        #countdown-overlay { position: absolute; font-size: 150px; font-weight: bold; color: var(--accent); z-index: 10; text-shadow: 0 0 20px rgba(0,210,255,0.5); }
        #timer-bar { font-size: 40px; margin-bottom: 20px; color: #f1c40f; }
        #round-info { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #888; }
    </style>
</head>
<body>

    <div id="room-setup">
        <h1>ğŸ™ï¸ å…«æ ¼æŒ‘æˆ°æˆ¿é–“</h1>
        <div class="card">
            <input type="text" id="roomInput" placeholder="è¼¸å…¥æˆ¿é–“åç¨± (ä¾‹å¦‚: myroom123)" style="width: 80%;">
            <button onclick="joinRoom()">é€²å…¥æˆ¿é–“</button>
            <p class="status">è¼¸å…¥ç›¸åŒæˆ¿é–“è™Ÿçš„è£ç½®å°‡æœƒåŒæ­¥è¨­å®š</p>
        </div>
    </div>

    <div id="main-ui" class="hidden">
        <h2 id="room-display">æˆ¿é–“: --</h2>
        <div class="card">
            <h3>1. ä¸Šå‚³é¡Œåº«</h3>
            <select id="bankSelector" style="width: 100%;">
                <option value="0">é¡Œåº« 1</option><option value="1">é¡Œåº« 2</option>
                <option value="2">é¡Œåº« 3</option>
            </select>
            <input type="file" id="imageInput" multiple accept="image/*" onchange="handleUpload()">
            <div id="bank-status" class="status">ç›®å‰åœ–ç‰‡æ•¸: 0</div>
        </div>

        <div class="card">
            <h3>2. æŒ‘æˆ°è¨­å®š</h3>
            å–®æ¬¡æŒ‘æˆ°ç§’æ•¸: <input type="number" id="secInput" value="8" style="width: 60px;">
            <button class="btn-start" onclick="openAndStart()">ğŸš€ é–‹å§‹æŒ‘æˆ° (é–‹å•Ÿæ–°è¦–çª—)</button>
        </div>
    </div>

    <div id="stage-ui" class="hidden">
        <div id="stage-content">
            <div id="round-info">ROUND 1/3</div>
            <div id="timer-bar">READY</div>
            <div id="countdown-overlay" class="hidden"></div>
            <div class="grid" id="gameGrid">
                <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
            </div>
        </div>
    </div>

    <script>
        let peer, conn;
        let banks = [[], [], []];
        const bc = new BroadcastChannel('game_sync');

        // --- æˆ¿é–“åŒæ­¥é‚è¼¯ ---
        function joinRoom() {
            const roomId = document.getElementById('roomInput').value;
            if (!roomId) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿ");

            // é€™è£¡ä½¿ç”¨ '8grid-' ä½œç‚ºå‰ç¶´é¿å…è¡çª
            peer = new Peer('8grid-' + roomId);
            
            peer.on('open', (id) => {
                document.getElementById('room-setup').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                document.getElementById('room-display').innerText = "æˆ¿é–“: " + roomId;
            });

            peer.on('connection', (c) => {
                c.on('data', data => syncState(data));
            });

            // å˜—è©¦é€£æ¥ç¾æœ‰çš„æˆ¿ä¸» (å¦‚æœ‰)
            setTimeout(() => {
                const c = peer.connect('8grid-' + roomId);
                c.on('open', () => { conn = c; });
            }, 1000);
        }

        function handleUpload() {
            const idx = document.getElementById('bankSelector').value;
            const files = Array.from(document.getElementById('imageInput').files);
            let loaded = 0;
            banks[idx] = [];
            
            files.forEach(f => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    banks[idx].push(e.target.result);
                    loaded++;
                    if(loaded === files.length) {
                        document.getElementById('bank-status').innerText = `ç›®å‰åœ–ç‰‡æ•¸: ${banks[idx].length}`;
                        broadcastState();
                    }
                };
                reader.readAsDataURL(f);
            });
        }

        function broadcastState() {
            if (conn) {
                conn.send({ type: 'SYNC', banks: banks, sec: document.getElementById('secInput').value });
            }
        }

        function syncState(data) {
            if (data.type === 'SYNC') {
                banks = data.banks;
                document.getElementById('secInput').value = data.sec;
                const idx = document.getElementById('bankSelector').value;
                document.getElementById('bank-status').innerText = `ç›®å‰åœ–ç‰‡æ•¸: ${banks[idx].length}`;
            }
        }

        // --- éŠæˆ²æ§åˆ¶é‚è¼¯ ---
        function openAndStart() {
            const bankIdx = document.getElementById('bankSelector').value;
            if (banks[bankIdx].length < 8) return alert("é¡Œåº«åœ–ç‰‡ä¸è¶³ 8 å¼µï¼");

            // é–‹å•Ÿæ–°è¦–çª—
            const stageWin = window.open('', 'GameDisplay', 'width=1200,height=800');
            stageWin.document.write(document.documentElement.innerHTML);
            
            // é€šçŸ¥æ–°è¦–çª—é–‹å§‹ (å»¶é²ç¢ºä¿è¦–çª—è¼‰å…¥å®Œæˆ)
            setTimeout(() => {
                const data = {
                    type: 'GAME_START',
                    bank: banks[bankIdx],
                    sec: document.getElementById('secInput').value
                };
                bc.postMessage(data);
            }, 1000);
        }

        // --- èˆå°åŸ·è¡Œé‚è¼¯ (å¾ªç’°æŒ‘æˆ°) ---
        bc.onmessage = async (e) => {
            if (e.data.type === 'GAME_START') {
                document.getElementById('main-ui').classList.add('hidden');
                document.getElementById('stage-ui').classList.remove('hidden');
                
                // åŸ·è¡Œä¸‰å€‹å¾ªç’°
                for (let i = 1; i <= 3; i++) {
                    await startOneCycle(i, e.data.bank, e.data.sec);
                }
                
                document.getElementById('timer-bar').innerText = "æŒ‘æˆ°å®Œæˆï¼";
            }
        };

        async function startOneCycle(round, bank, sec) {
            const timerEl = document.getElementById('timer-bar');
            const roundEl = document.getElementById('round-info');
            const overlay = document.getElementById('countdown-overlay');
            const boxes = document.querySelectorAll('.box');

            roundEl.innerText = `ROUND ${round}/3`;
            boxes.forEach(b => b.classList.remove('active'));

            // 1. å€’æ•¸ 3, 2, 1
            overlay.classList.remove('hidden');
            for (let c = 3; c > 0; c--) {
                overlay.innerText = c;
                await new Promise(r => setTimeout(r, 1000));
            }
            overlay.classList.add('hidden');

            // 2. éš¨æ©Ÿé¸4å¼µä¸¦å¡«æ»¿8æ ¼
            const luckyFour = [...bank].sort(() => 0.5 - Math.random()).slice(0, 4);
            const gridImgs = [...luckyFour, ...luckyFour].sort(() => 0.5 - Math.random());

            boxes.forEach((box, i) => {
                box.innerHTML = `<img src="${gridImgs[i]}" style="display:block">`;
                box.classList.add('active');
            });

            // 3. æŒ‘æˆ°è¨ˆæ™‚
            let timeLeft = sec;
            timerEl.innerText = timeLeft + "s";
            while (timeLeft > 0) {
                await new Promise(r => setTimeout(r, 1000));
                timeLeft--;
                timerEl.innerText = timeLeft + "s";
            }

            // 4. æ¸…é™¤ç‹€æ…‹ä¸¦ä¼‘æ¯ä¸€ä¸‹
            boxes.forEach(b => b.classList.remove('active'));
            timerEl.innerText = "ä¼‘æ¯ä¸€ä¸‹...";
            await new Promise(r => setTimeout(r, 2000));
        }
    </script>
</body>
</html>
