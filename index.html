<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Grid Short ID Challenge</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #1a1a1a; --card: #2d2d2d; --accent: #00d2ff; --text: #eee; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none !important; }
        .card { background: var(--card); padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-top: 20px; text-align: center; }
        
        button { padding: 12px 24px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 10px 5px; }
        .btn-create { background: #0984e3; color: white; }
        .btn-join { background: #6c5ce7; color: white; }
        .btn-start { background: #ff4757; color: white; width: 100%; margin-top: 20px; font-size: 18px; }
        input, select { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a1a; color: white; width: 100%; box-sizing: border-box; margin-top: 10px; text-align: center; }
        
        .room-id-tag { font-size: 42px; color: var(--accent); font-family: 'Courier New', Courier, monospace; font-weight: bold; letter-spacing: 5px; margin: 20px 0; border: 2px dashed #444; padding: 10px; border-radius: 10px; }

        /* éŠæˆ²èˆå° */
        #stage-ui { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: repeat(4, 180px); grid-template-rows: repeat(2, 180px); gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: repeat(4, 22vw); grid-template-rows: repeat(2, 22vw); } }
        .box { background: #222; border: 2px solid #444; border-radius: 10px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .box.active img { display: block; }
        #countdown-txt { position: absolute; font-size: 150px; font-weight: bold; color: var(--accent); text-shadow: 0 0 30px rgba(0,210,255,1); pointer-events: none; }
        #round-info { font-size: 28px; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="init-menu" class="card">
        <h1>ğŸ™ï¸ å…«æ ¼æŒ‘æˆ°</h1>
        <p>é¸æ“‡ä½ çš„è§’è‰²é–‹å§‹é€£ç·š</p>
        <button class="btn-create" onclick="showCreate()">â• å»ºç«‹æˆ¿é–“</button>
        <button class="btn-join" onclick="showJoin()">ğŸšª é€²å…¥æˆ¿é–“</button>
    </div>

    <div id="create-panel" class="card hidden">
        <h2>æˆ¿é–“å·²å»ºç«‹ï¼</h2>
        <p>è«‹å°‡ 6 ç¢¼ ID å‘Šè¨´åƒèˆ‡è€…ï¼š</p>
        <div id="my-id-display" class="room-id-tag">......</div>
        <p id="conn-status" style="color:#aaa;">ç­‰å¾…é€£ç·šä¸­...</p>
        <button onclick="location.reload()">é—œé–‰æˆ¿é–“</button>
    </div>

    <div id="join-panel" class="card hidden">
        <h2>é€²å…¥æˆ¿é–“</h2>
        <input type="text" id="target-id" placeholder="è«‹è¼¸å…¥ 6 ç¢¼æˆ¿é–“ ID" maxlength="6" style="text-transform: uppercase; font-size: 24px;">
        <button class="btn-join" onclick="connectToHost()">ç¢ºèªé€£ç·š</button>
        <button onclick="location.reload()">è¿”å›</button>
    </div>

    <div id="lobby-ui" class="card hidden">
        <h2 id="role-title">éŠæˆ²å¤§å»³</h2>
        <div style="text-align: left;">
            <label>ğŸ“ é¸æ“‡é¡Œåº«ï¼š</label>
            <select id="bankSelector" onchange="syncSettings()">
                <option value="0">é¡Œåº« 1</option><option value="1">é¡Œåº« 2</option><option value="2">é¡Œåº« 3</option>
            </select>
            <input type="file" id="imageInput" multiple accept="image/*" onchange="handleUpload()">
            <p id="bank-status" style="font-size:13px; color:#00fbff;">å°šæœªè¼‰å…¥åœ–ç‰‡ (å»ºè­° 8 å¼µ)</p>
            
            <label>â±ï¸ æŒ‘æˆ°ç§’æ•¸ï¼š</label>
            <input type="number" id="secInput" value="8" onchange="syncSettings()">
        </div>
        <button class="btn-start" id="startBtn" onclick="triggerChallenge()">ğŸš€ é–‹å§‹æŒ‘æˆ° (ä¸‰å¾ªç’°)</button>
    </div>

    <div id="stage-ui" class="hidden">
        <div id="round-info">ROUND 1 / 3</div>
        <div id="timer-bar" style="font-size: 56px; color: #f1c40f; margin: 10px 0;">READY</div>
        <div id="countdown-txt"></div>
        <div class="grid">
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
        </div>
    </div>

    <script>
        let peer, conn, isHost = false;
        let banks = [[], [], []];

        // ç”Ÿæˆéš¨æ©Ÿ 6 ç¢¼è‹±æ•¸
        function generateShortID() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function showCreate() {
            const shortID = generateShortID();
            document.getElementById('init-menu').classList.add('hidden');
            document.getElementById('create-panel').classList.remove('hidden');
            document.getElementById('my-id-display').innerText = shortID;
            initPeer(true, shortID);
        }

        function showJoin() {
            document.getElementById('init-menu').classList.add('hidden');
            document.getElementById('join-panel').classList.remove('hidden');
            initPeer(false);
        }

        function initPeer(hostMode, customID = null) {
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œä½¿ç”¨ customIDï¼›å¦‚æœæ˜¯æˆå“¡ï¼Œéš¨æ©Ÿç”Ÿæˆ ID
            peer = customID ? new Peer(customID) : new Peer();
            
            peer.on('open', (id) => {
                if (hostMode) isHost = true;
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    alert("ID å·²è¢«ä½”ç”¨ï¼Œè«‹é‡æ–°å»ºç«‹æˆ–æª¢æŸ¥ IDã€‚");
                    location.reload();
                } else {
                    alert("é€£ç·šå‡ºéŒ¯ï¼š" + err.type);
                }
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConnListeners();
                document.getElementById('create-panel').classList.add('hidden');
                document.getElementById('lobby-ui').classList.remove('hidden');
                document.getElementById('role-title').innerText = "æˆ¿ä¸»æ§åˆ¶ä¸­";
            });
        }

        function connectToHost() {
            const hostId = document.getElementById('target-id').value.toUpperCase();
            if (!hostId) return alert("è«‹è¼¸å…¥ ID");
            
            conn = peer.connect(hostId);
            conn.on('open', () => {
                isHost = false;
                document.getElementById('role-title').innerText = "æˆå“¡é€£ç·šä¸­";
                document.getElementById('join-panel').classList.add('hidden');
                document.getElementById('lobby-ui').classList.remove('hidden');
                document.getElementById('startBtn').classList.add('hidden');
                setupConnListeners();
            });
            conn.on('error', () => alert("ç„¡æ³•é€£ç·šè‡³è©²æˆ¿é–“ï¼Œè«‹ç¢ºèª ID æ˜¯å¦æ­£ç¢ºã€‚"));
        }

        function setupConnListeners() {
            conn.on('data', (data) => {
                if (data.type === 'SYNC') {
                    banks = data.banks;
                    document.getElementById('secInput').value = data.sec;
                    document.getElementById('bankSelector').value = data.bankIdx;
                    updateBankStatus();
                } else if (data.type === 'START_GAME') {
                    runTripleCycle(data.bank, data.sec);
                }
            });
        }

        function handleUpload() {
            const idx = document.getElementById('bankSelector').value;
            const files = Array.from(document.getElementById('imageInput').files);
            banks[idx] = [];
            let count = 0;
            files.forEach(f => {
                const reader = new FileReader();
                reader.onload = e => {
                    banks[idx].push(e.target.result);
                    count++;
                    if (count === files.length) {
                        updateBankStatus();
                        syncSettings();
                    }
                };
                reader.readAsDataURL(f);
            });
        }

        function syncSettings() {
            if (conn && conn.open) {
                conn.send({
                    type: 'SYNC',
                    banks: banks,
                    sec: document.getElementById('secInput').value,
                    bankIdx: document.getElementById('bankSelector').value
                });
            }
        }

        function updateBankStatus() {
            const idx = document.getElementById('bankSelector').value;
            document.getElementById('bank-status').innerText = `é¡Œåº« ${parseInt(idx)+1} å·²è¼‰å…¥ ${banks[idx].length} å¼µåœ–ç‰‡`;
        }

        function triggerChallenge() {
            const idx = document.getElementById('bankSelector').value;
            const sec = document.getElementById('secInput').value;
            if (banks[idx].length < 4) return alert("åœ–ç‰‡ä¸è¶³ 4 å¼µï¼");

            const gameData = { type: 'START_GAME', bank: banks[idx], sec: sec };
            if (conn) conn.send(gameData);
            runTripleCycle(banks[idx], sec);
        }

        async function runTripleCycle(bank, sec) {
            document.getElementById('stage-ui').classList.remove('hidden');
            const timerEl = document.getElementById('timer-bar');
            const roundEl = document.getElementById('round-info');
            const overlay = document.getElementById('countdown-txt');
            const boxes = document.querySelectorAll('.box');

            for (let r = 1; r <= 3; r++) {
                roundEl.innerText = `ROUND ${r} / 3`;
                boxes.forEach(b => { b.innerHTML = ""; b.classList.remove('active'); });
                
                for (let c = 3; c > 0; c--) {
                    overlay.innerText = c;
                    await new Promise(res => setTimeout(res, 1000));
                }
                overlay.innerText = "";

                const lucky4 = [...bank].sort(() => 0.5 - Math.random()).slice(0, 4);
                const final = [...lucky4, ...lucky4].sort(() => 0.5 - Math.random());
                boxes.forEach((b, i) => {
                    b.innerHTML = `<img src="${final[i]}" style="display:block">`;
                    b.classList.add('active');
                });

                let left = parseInt(sec);
                while (left >= 0) {
                    timerEl.innerText = left + "s";
                    await new Promise(res => setTimeout(res, 1000));
                    left--;
                }

                timerEl.innerText = "READY...";
                boxes.forEach(b => b.classList.remove('active'));
                await new Promise(res => setTimeout(res, 1500));
            }

            timerEl.innerText = "FINISH!";
            setTimeout(() => { document.getElementById('stage-ui').classList.add('hidden'); }, 3000);
        }
    </script>
</body>
</html>
